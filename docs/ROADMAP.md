# Roadmap

## Phase 1: Foundation âœ…
- [x] Projekt-Setup
- [x] Core-Datenmodelle (`RoadMap`, `MapNode`, `Connection`)
- [x] XML-Parser (Import)
- [x] XML-Writer (Export)
  - [x] XML-Deklaration korrekt (encoding="utf-8", standalone="no")
  - [x] Koordinaten-PrÃ¤zision (3 Dezimalstellen)
  - [x] Optionen-Reihenfolge beibehalten
  - [x] Marker-Import/Export
  - [x] Heightmap-Integration (PNG-Loader)
  - [x] Bikubische Interpolation fÃ¼r Y-Koordinaten
- [x] Roundtrip-Tests (XML Import â†’ Export â†’ Diff)
- [x] Flag-Bereinigung (AutoGenerated/SplineGenerated â†’ Regular)
- [x] Integration-Tests mit echten AutoDrive-Configs

## Phase 2: 2D-Rendering âœ…
- [x] wgpu Setup und Basic 2D-Rendering
- [x] Node Instancing (Punkte als Quads)
- [x] Connection Instancing (Linien mit Pfeilspitzen)
- [x] 2D-Kamera-System (Pan, Zoom)
- [x] Viewport-Culling (CPU-basiert im Renderpfad)
- [x] Map-Image-Rendering (DDS/PNG/JPG-Hintergrund)
- [x] Render-Quality-Presets im UI

## Phase 3: UI Basics âœ…
- [x] egui Integration
- [x] Toolbar (Tool-Auswahl: Select, Connect, AddNode)
- [x] Status-Panel (Node-Count, Selection-Info)
- [x] File-Dialogs (Open)
- [x] File-Dialogs (Save mit Heightmap-Warnung)
- [x] File-Dialogs (Save As)
- [ ] Basic Theme/Icons
- [x] Keyboard-Shortcuts (Ctrl+O, Ctrl+S, Ctrl+Z, Ctrl+Y, Delete, Escape, etc.)
- [x] Options-Dialog (Farben, GrÃ¶ÃŸen, Breiten â€“ Live-Preview)
- [x] TOML-Persistierung (fs25_auto_drive_editor.toml neben Binary)

## Phase 4: Editor-Tools âœ… (Kern abgeschlossen)
- [x] **KD-Tree Integration (kiddo)**
  - [x] Spatial Index in RoadMap integrieren
  - [x] Query-API: `nearest_node()`, `nodes_within_radius()`, `nodes_within_rect()`
  - [x] Auto-Update bei Node-Mutationen
  - [ ] Performance-Tests (100k+ Nodes)
- [x] **Select Tool (Click)**
  - [x] World-Koordinaten-Transformation (Screen â†’ World)
  - [x] Node-Picking via KD-Tree
  - [x] Selection-State in AppState
  - [x] Visuelle Hervorhebung (Shader/Farbe)
  - [x] AppIntent: `NodePickRequested`, additive/extend_path Selektion
- [x] **Move Tool (Drag & Drop)**
  - [x] Drag-Start/Drag-Move/Drag-End Events (Lifecycle: Begin/Move/End)
  - [x] Node-Position aktualisieren (Use-Case: `move_selected_nodes`)
  - [x] Spatial-Index-Update nach Move
- [x] Rectangle Select (Multi-Selection)
- [x] Lasso-Selection
- [x] Segment-Selektion (zwischen Kreuzungen)
- [x] Add Node Tool (Click zum HinzufÃ¼gen)
- [x] Delete Tool (selektierte Nodes lÃ¶schen)
- [x] Connect Tool (Regular, Dual, Reverse)
  - [x] Connection-Direction UI (Standard-Richtung wÃ¤hlbar)
  - [x] Connection-PrioritÃ¤t UI (Regular/SubPrio)
  - [x] Bulk-Operationen (alle Verbindungen zwischen Selektion Ã¤ndern/invertieren/trennen)
- [x] **Undo/Redo-System**
  - [x] Snapshot-basiertes Undo/Redo (max. 200 Schritte)
  - [x] UI-Buttons + Shortcuts (Ctrl+Z / Ctrl+Y)
  - [x] CommandLog fÃ¼r Debug-Zwecke
- [x] Properties-Panel (Node-IDs, Positionen, Verbindungen anzeigen/editieren)
- [x] Context-Menu (Rechtsklick â†’ Verbindungsaktionen)

## Phase 5: Advanced Features
- [x] DDS-Import fÃ¼r Map-HintergrÃ¼nde
  - [x] Texture-Loader implementieren (PNG, JPG, DDS)
  - [x] Background-Quad-Renderer
  - [x] Map-Auswahl UI (Datei-Dialog + MenÃ¼)
  - [x] Opacity- und Sichtbarkeits-Steuerung
  - [ ] Zoom-abhÃ¤ngige LOD
- [ğŸŸ¡] Kurven-Werkzeuge (Bezier, Spline)
  - [x] Bezier-Interpolation (Grad 2 + 3)
  - [x] Catmull-Rom-Spline (interpolierend, durch alle Punkte)
  - [x] Auto-Generation von Intermediate-Nodes
  - [x] Kurven-Preview
  - [x] Sequentielle Steuerpunkt-Platzierung (kein Ctrl+Klick)
  - [x] Drag-basierte Steuerpunkt-Anpassung
- [ğŸŸ¡] Marker-Management
  - [x] Marker-Icons im Viewport (GPU-Instanced Pin-Symbole)
  - [x] Marker erstellen/lÃ¶schen (Use-Case + KontextmenÃ¼)
  - [x] Marker-Editor UI (Name, Gruppe bearbeiten)
  - [ ] Marker-Groups
- [ ] Grid-Overlay & Snap-to-Grid
- [ ] Minimap-Ansicht

## Phase 6: Performance & QualitÃ¤t
- [ ] Performance-Optimierung
  - [x] `within_rect` auf KD-Tree Range-Query umstellen (aktuell O(n) Brute-Force)
  - [x] **Connection-Lookup O(1):** `connections: Vec<Connection>` â†’ `HashMap<(u64,u64), Connection>`
  - [x] **COW-Undo via `Arc<RoadMap>`:** Snapshot ist O(1) statt O(n) Deep-Clone (Copy-on-Write)
  - [ ] LOD-System fÃ¼r groÃŸe Strecken
  - [ ] Memory-Profiling
  - [x] `ctx.request_repaint()` nur bei Ã„nderungen (CPU-Idle-Verbrauch reduzieren)
- [ğŸŸ¡] Error-Handling & User-Feedback
  - [x] unwrap()-Aufrufe in Produktionscode durch graceful handling ersetzt
  - [ ] Toast-Notifications
  - [ ] Loading-Spinner
  - [ ] Error-Recovery
  - [ ] Input-Validierung
- [ ] Testing
  - [x] Roundtrip-Tests vollstÃ¤ndig (Basis)
  - [ ] UI-Integration-Tests
  - [x] Performance-Benchmarks (Basis mit Criterion)
  - [ ] Performance-Benchmarks mit 100k+ Nodes
- [ğŸŸ¡] Dokumentation
  - [ ] User-Guide
  - [x] API-Dokumentation pro Modul (API.md inkl. shared)
  - [ ] Keyboard-Shortcuts-Ãœbersicht
  - [x] Architektur-Analyse und API.md-NachfÃ¼hrung (2026-02-20)
  - [x] Handler-Split und Architektur-Guardrails dokumentiert (2025-07-02)
- [ ] Packaging
  - [ ] Windows Binaries (.exe)
  - [ ] Linux Binaries (AppImage)
  - [ğŸŸ¡] CI/CD Pipeline
    - [x] Layer-Boundary-Check-Script (`scripts/check_layer_boundaries.sh`)
    - [x] Makefile-Integration (`make ci-check`)
    - [ ] GitHub Actions Workflow

## Phase 7: Optional / Future
- [ ] Web-Version (WASM)
  - [ ] wgpu WebGL/WebGPU Backend
  - [ ] Browser-File-Access
  - [ ] GitHub Pages Deployment
- [ ] Android-Support (optional)
- [ ] Online-Map-Image-Lookup
  - [ ] Giants Map-Repository Integration
  - [ ] Automatischer Download
- [ ] Auto-Save
  - [ ] Periodisches Speichern
  - [ ] Recovery nach Crash
- [ ] Plugin-System
  - [ ] Lua/WASM Scripting
  - [ ] Custom Tools API
- [ ] Collaborative Editing
  - [ ] Multi-User via WebSocket
  - [ ] Conflict Resolution
- [ ] Import/Export andere Formate
  - [ ] FS22 Legacy Support
  - [ ] CSV/JSON Export
  - [ ] GPS-Track Import

---

## ğŸ¯ MVP-Checkliste (Minimale nutzbare Version)

**Muss haben fÃ¼r MVP:**
- [x] XML Import/Export
- [x] Roundtrip-Tests bestehen
- [x] Viewport mit Pan/Zoom
- [x] KD-Tree Spatial Index
- [x] Select Tool (Click, Rect, Lasso, Segment)
- [x] Move Tool (Drag)
- [x] Save-Dialog (mit Heightmap-Warnung)
- [x] Undo/Redo
- [x] Save As Dialog

**Status: MVP zu ~100% erreicht.**

---

## ğŸ“Š Aktueller Status (Stand: 2026-02-20)

**Fertigstellung:**
- Phase 1: âœ… 100%
- Phase 2: âœ… 100%
- Phase 3: âœ… 98% (Theme fehlt)
- Phase 4: âœ… 100% (alle Features implementiert, 100k-Benchmarks ausstehend)
- Phase 5: ğŸŸ¡ 85% (DDS-Background + Marker-Editor + BÃ©zier-Kurven + Catmull-Rom-Spline fertig)
- Phase 6: ğŸŸ¡ 40% (Handler-Split, CI-Checks, unwrap-Bereinigung, API-Docs nachgefÃ¼hrt)

**Errungenschaften seit letztem Update (Spline-Tool 2026-02-21):**
- âœ… Neues Route-Tool: Catmull-Rom-Spline (interpolierend, Kurs fÃ¼hrt durch alle geklickten Punkte)
- âœ… Arc-Length-Resampling fÃ¼r gleichmÃ¤ÃŸige Node-Verteilung
- âœ… Fortlaufende Vorschau (Cursor als nÃ¤chster Punkt)
- âœ… Einstellungen: Min. Abstand / Anzahl Nodes (wie Linie/Kurve)
- âœ… Verkettung und Nachbearbeitung unterstÃ¼tzt
- âœ… 11 Unit-Tests (Geometrie + Tool-Flow)

**Errungenschaften (Modularisierungs-Session 2026-02-21):**
- âœ… Tool-Preview-Overlay aus `main.rs` in eigenstÃ¤ndiges `ui/tool_preview.rs`-Modul extrahiert (65 Zeilen Inline-Code entfernt)
- âœ… DRY-Refactor `apply_tool_result.rs`: gemeinsame Logik in `apply_result_inner()` + `create_nodes_and_connections()` extrahiert (~60 Zeilen Duplikation eliminiert)
- âœ… DRY-Refactor `straight_line.rs`: gemeinsame `build_result()`-Funktion fÃ¼r `execute()` und `execute_from_anchors()` (~120 Zeilen Duplikation eliminiert)
- âœ… Layer-Fix: `tool_preview.rs` importiert `Camera2D`/`RoadMap` Ã¼ber app-Re-Exports
- âœ… Alle Markdown-Docs nachgefÃ¼hrt (API.md, ARCHITECTURE_PLAN.md, ROADMAP.md)
- âœ… 134 Tests grÃ¼n, Clippy sauber, Layer-Check bestanden

**Errungenschaften (Vorherige Refactoring-Session):**
- âœ… `connections` in `RoadMap`: `Vec<Connection>` â†’ `HashMap<(u64,u64), Connection>` â€” alle lookup-Operationen O(1)
- âœ… COW-Undo: `Snapshot` nutzt `Arc<RoadMap>` statt Deep-Clone â€” O(1) statt O(n) pro Undo-Schritt
- âœ… Shader-Deduplication: `shaders.wgsl` wird einmal in `Renderer::new()` geladen, an alle 4 Sub-Renderer weitergegeben
- âœ… `center_on_road_map` aus `file_io.rs` in `use_cases/camera.rs` extrahiert (Separation of Concerns)
- âœ… `background_dirty: bool` in `ViewState` ersetzt fragiles Arc-Pointer-Tracking in `main.rs`
- âœ… `MarkerDialogConfirmed`: `is_new: bool` in Intent kodiert â€” Controller-Mapping ohne State-AbhÃ¤ngigkeit
- âœ… `connections_iter()` + `invert_connection()` als neue Ã¶ffentliche RoadMap-API hinzugefÃ¼gt
- âœ… Alle 29 Tests grÃ¼n nach dem Refactoring

**Errungenschaften (Vorherige Session):**
- âœ… Architektur-Verletzung behoben: `ui/dialogs.rs` importiert `RoadMap` via `app` statt direkt aus `core`
- âœ… `core`-Modul von `shared`-AbhÃ¤ngigkeit entkoppelt: Kamera-Konstanten direkt in `Camera2D`, `pick_radius_world()` nimmt `pick_radius_px`-Parameter
- âœ… Alle 6 API.md-Dateien auf aktuellen Code-Stand nachgefÃ¼hrt
- âœ… Marker-Editor UI (Name + Gruppe) als erledigt markiert
- âœ… DDS-Background-Map vollstÃ¤ndig (Phase 2 + Phase 5 korrigiert)
- âœ… Options-Dialog implementiert (Farben, GrÃ¶ÃŸen, Breiten â€“ Live-Preview)
- âœ… TOML-Persistierung: `fs25_auto_drive_editor.toml` neben Binary, automatisches Laden/Speichern
- âœ… Alle Render-Konstanten von Kompilierzeit auf Laufzeit-Optionen umgestellt
- âœ… `render/types.rs` bereinigt: obsolete Konstanten-Duplikate entfernt
- âœ… `unwrap()` in `src/app/use_cases/**` eliminiert (frÃ¼he Returns + Guard-Checks)
- âœ… `main.rs` in Runner/Adapter-Schritte aufgeteilt (`AppRunner`, Event-/Render-Adapter-Methoden)
- âœ… Gezielte Tests ergÃ¤nzt:
  - UI Inputâ†’Intent: Keyboard-Shortcut-Mapping (`src/ui/keyboard.rs` Unit-Tests)
  - Render Culling-Basis: Geometrie-/Schnittlogik (`src/render/connection_renderer.rs` Unit-Tests)

**Errungenschaften (Architektur-Session 2025-07-02):**
- âœ… Controller in Feature-Handler aufgeteilt (`handlers/file_io`, `view`, `selection`, `editing`, `route_tool`, `dialog`, `history`)
- âœ… UIâ†’Core-Layerverletzung behoben (`properties.rs` importiert `RoadMap` via `app` statt direkt aus `core`)
- âœ… CI-Check-Script fÃ¼r Schichtgrenzen (`scripts/check_layer_boundaries.sh` + Makefile-Integration)
- âœ… Alle `unwrap()`-Aufrufe in Produktionscode durch graceful error handling ersetzt
- âœ… Alle Markdown-Dokumentationen auf aktuellen Code-Stand nachgefÃ¼hrt
- âœ… Alle Tests grÃ¼n nach Refactoring

**Hinweis zu Doku/Automatisierung:**
- â„¹ï¸ Dokumentation wird aktuell manuell gepflegt (kein Auto-Sync-Mechanismus aktiv)
- âœ… CI-Basis vorhanden: Layer-Boundary-Check via `make ci-check`

**NÃ¤chste Aufgaben:**
1. ğŸŸ¡ 100k+ Performance-Benchmarks
2. ğŸŸ¢ Undo/Redo auf Delta-basiert umstellen (Skalierung fÃ¼r 100k+ Nodes)
3. ğŸŸ¢ LOD-System fÃ¼r groÃŸe Strecken
4. ğŸŸ¢ Theme/Icons
5. ğŸŸ¢ Marker-Groups
6. ğŸŸ¢ Toast-Notifications fÃ¼r User-Feedback
