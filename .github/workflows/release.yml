name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always
    CARGO_TARGET_DIR: target
    BIN_NAME: FS25-AutoDrive-Editor

jobs:
    build-linux:
        name: Build Linux x64
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: linux-release-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: linux-release-

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
                    libxkbcommon-dev libssl-dev libgtk-3-dev

            - name: Build
              run: cargo build --release

            - name: Strip binary
              run: strip target/release/${{ env.BIN_NAME }}

            - name: Rename binary
              run: cp target/release/${{ env.BIN_NAME }} ${{ env.BIN_NAME }}_x64_linux

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-binary
                  path: ${{ env.BIN_NAME }}_x64_linux

    build-windows:
        name: Build Windows x64
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: windows-release-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: windows-release-

            - name: Build
              run: cargo build --release

            - name: Rename binary
              run: copy target\release\${{ env.BIN_NAME }}.exe ${{ env.BIN_NAME }}_x64_windows.exe

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-binary
                  path: ${{ env.BIN_NAME }}_x64_windows.exe

    release:
        name: Create GitHub Release
        needs: [build-linux, build-windows]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Download Linux binary
              uses: actions/download-artifact@v4
              with:
                  name: linux-binary

            - name: Download Windows binary
              uses: actions/download-artifact@v4
              with:
                  name: windows-binary

            - name: Make Linux binary executable
              run: chmod +x ${{ env.BIN_NAME }}_x64_linux

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      ${{ env.BIN_NAME }}_x64_linux
                      ${{ env.BIN_NAME }}_x64_windows.exe
