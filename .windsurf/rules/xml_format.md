# AutoDrive XML-Format

## Struktur
Das AutoDrive Config-Format nutzt **Structure of Arrays** (SoA): Parallele Listen in separaten XML-Tags.

## Beispiel
```xml
<?xml version="1.0" encoding="utf-8" standalone="no"?>
<AutoDrive>
    <version>3.0.0.4</version>
    <MapName>Example Map</MapName>
    <waypoints>
        <id>1,2,3,4</id>
        <x>100.500,200.300,150.700,180.200</x>
        <y>50.000,51.200,52.100,50.500</y>
        <z>300.100,350.800,320.500,340.900</z>
        <out>2,3;3,4;;1</out>
        <incoming>4;1;2;3</incoming>
        <flags>0,0,1,0</flags>
    </waypoints>
    <mapmarker>
        <!-- Marker-Definition -->
    </mapmarker>
</AutoDrive>
```

## Delimiter-Regeln
- **Comma (`,`):** Für einfache Listen (id, x, y, z, flags)
- **Semicolon (`;`):** Für verschachtelte Listen (out, incoming) - äußere Ebene
- **Comma (`,`):** Innerhalb der verschachtelten Listen

### Beispiel `out`-Feld
```
out = "2,3;3,4;;1"
```
Bedeutet:
- Node 1 hat Connections zu [2, 3]
- Node 2 hat Connections zu [3, 4]
- Node 3 hat keine Connections ([])
- Node 4 hat Connection zu [1]

## Versions-Logik (Wichtig!)

### FS22/FS25 Flag-Bereinigung
Beim **Laden** von Configs mit `version >= 2`:
- Prüfe alle `flags` Werte
- Wenn Flag == 2 oder Flag == 4:
  - Diese wurden automatisch von AutoDrive generiert (Spline-Import)
  - Setze sie auf 0 (Regular) zurück
  - Grund: Editierte Nodes sollen nicht mehr als "Auto-Generated" markiert sein

```rust
// Pseudo-Code
if config.version >= 2 {
    for flag in &mut node.flags {
        if *flag == 2 || *flag == 4 {
            *flag = 0; // Regular
        }
    }
}
```

## Flag-Bedeutungen
```rust
pub enum NodeFlag {
    Regular = 0,
    Parking = 1,
    AutoGenerated = 2,    // FS22+ nur beim Import
    Reserved = 3,
    SplineGenerated = 4,  // FS22+ nur beim Import
    Warning = 5,
    // ... weitere Flags
}
```

## Parsing-Strategie
1. Lese alle parallelen Listen in separate `Vec<String>`
2. Parse jede Liste in ihren Zieltyp (`Vec<f32>`, `Vec<u64>`, etc.)
3. Validiere, dass alle Listen gleiche Länge haben
4. Konstruiere Nodes aus parallelen Indizes:
   ```rust
   for i in 0..ids.len() {
       let node = MapNode {
           id: ids[i],
           x: x_coords[i],
           y: y_coords[i],
           z: z_coords[i],
           // ...
       };
   }
   ```

## Error-Handling
- Fehlende Tags → Leere Listen (oder Fehler, je nach Kontext)
- Ungültige Zahlenformate → Parsing-Fehler
- Längen-Mismatch → Kritischer Fehler
- Unbekannte Version → Warning, aber weitermachen
